<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IntelliGo</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --text: #e7eefc;
      --muted: #9fb0d0;
      --accent: #37d6a6;
      --nav-h: 56px;
      --composer-h: 96px;
      --line: rgba(255,255,255,0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", Arial;
      background: var(--bg); color: var(--text);
    }
    .app { height: 100vh; display: flex; flex-direction: column; }
    header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,0.15);
      backdrop-filter: blur(6px);
    }
    header .title { font-weight: 700; letter-spacing: .2px; }
    header .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }

    main {
      flex: 1;
      overflow: auto;
      padding: 12px 12px calc(var(--nav-h) + var(--composer-h) + 16px);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
    }

    .chat-list { display: flex; flex-direction: column; gap: 10px; }
    .msg {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      max-width: 92%;
      white-space: pre-wrap;
      line-height: 1.45;
    }
    .msg.user { align-self: flex-end; background: rgba(55,214,166,0.10); }
    .msg.ai { align-self: flex-start; background: rgba(255,255,255,0.03); }
    .meta { color: var(--muted); font-size: 12px; margin-top: 6px; }

    /* ç¤ºä¾‹é—®é¢˜å—ï¼ˆæ¯”æ­£æ–‡å°ä¸€ç‚¹ï¼Œæ›´ç²¾è‡´ï¼‰ */
    .suggestions {
      align-self: flex-start;
      max-width: 92%;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(255,255,255,0.02);
    }
    .suggestions-title {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .suggestion-list { display: flex; flex-direction: column; gap: 6px; }
    .suggestion-btn {
      text-align: left;
      width: 100%;
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.35;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(55,214,166,0.10);
      color: var(--text);
      cursor: pointer;
    }
    .suggestion-btn:hover { border-color: rgba(55,214,166,0.45); }
    .suggestion-btn:active { transform: translateY(0.5px); }

    .composer {
      position: fixed;
      left: 0; right: 0;
      bottom: var(--nav-h);
      padding: 10px 10px;
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
    }
    .row { display: flex; gap: 8px; }
    input[type="text"]{
      flex: 1;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 10px 12px;
      outline: none;
    }
    button {
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(55,214,166,0.15);
      color: var(--text);
      padding: 10px 12px;
    }
    button:disabled { opacity: .55; }

    nav {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: 56px;
      display: flex;
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(8px);
    }
    .tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-weight: 600;
      border: none;
      background: transparent;
    }
    .tab.active { color: var(--accent); }

    .hidden { display: none; }

    .kv { display: grid; grid-template-columns: 90px 1fr; gap: 8px 10px; }
    .k { color: var(--muted); }
    .v { word-break: break-word; }
    .small { font-size: 12px; color: var(--muted); }

    /* ç”¨æˆ·ç”»åƒå¡ç‰‡æ ·å¼ */
    .profile-summary {
      background: linear-gradient(135deg, rgba(55,214,166,0.15), rgba(55,214,166,0.05));
      border: 1px solid rgba(55,214,166,0.3);
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 14px;
      font-size: 14px;
      line-height: 1.5;
    }
    .profile-summary .label { color: var(--muted); font-size: 12px; margin-bottom: 4px; }
    .profile-cards { display: flex; flex-direction: column; gap: 10px; margin-bottom: 14px; }
    .profile-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .profile-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .profile-card-icon { font-size: 18px; }
    .profile-card-items { display: flex; flex-direction: column; gap: 6px; }
    .profile-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
    }
    .profile-item-text { flex: 1; }
    .profile-item-source {
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
      white-space: nowrap;
    }
    .profile-item-source:hover { color: var(--accent); }
    .source-detail {
      display: none;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      padding: 8px;
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
    }
    .source-detail.show { display: block; }
    .profile-empty {
      color: var(--muted);
      text-align: center;
      padding: 20px;
      font-size: 14px;
    }
    .btn-danger {
      background: rgba(220,53,69,0.2);
      border-color: rgba(220,53,69,0.4);
    }
    .btn-danger:hover { background: rgba(220,53,69,0.3); }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">IntelliGo</div>
      <div class="sub">æ‰‹æœºç«¯ï¼ˆèŠå¤© / ç”¨æˆ·èµ„æ–™ï¼‰</div>
    </header>

    <main>
      <!-- Chat View -->
      <section id="view-chat">
        <div class="chat-list" id="chatList"></div>
        <div class="small" style="margin-top:10px;">
          æç¤ºï¼šç¬¬ä¸€æ¬¡ä½¿ç”¨ä¼šè‡ªåŠ¨ç”Ÿæˆ session_idï¼›ä½ ä¹Ÿå¯ä»¥åœ¨â€œç”¨æˆ·èµ„æ–™â€é‡Œé‡ç½®ä¼šè¯ã€‚
        </div>
      </section>

      <!-- Profile View -->
      <section id="view-profile" class="hidden">
        <div class="card">
          <div style="font-weight:700; margin-bottom:12px;">ç”¨æˆ·ç”»åƒ</div>

          <div class="profile-summary" id="profileSummary">
            <div class="label">ä½ çš„åå¥½æ€»ç»“</div>
            <div id="summaryText">-</div>
          </div>

          <div class="profile-cards" id="profileCards"></div>

          <div class="row" style="gap: 8px; flex-wrap: wrap;">
            <button id="btnRefreshProfile">åˆ·æ–°èµ„æ–™</button>
            <button id="btnReset">é‡ç½®ä¼šè¯</button>
            <button id="btnClearProfile" class="btn-danger">æ¸…ç©ºç”»åƒ</button>
          </div>

          <div class="small" id="profileHint" style="margin-top:10px;"></div>

          <div style="margin-top: 14px; padding-top: 10px; border-top: 1px solid var(--line);">
            <div class="kv">
              <div class="k">session_id</div>
              <div class="v" id="sidText" style="font-size: 12px;">-</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div class="composer" id="composer">
      <div class="row">
        <input id="input" type="text" placeholder="è¯´ç‚¹ä»€ä¹ˆï¼Œä¾‹å¦‚ï¼šå‘¨æœ«æƒ³å»æ­å·ç©ä¸¤å¤©ï¼Œå–œæ¬¢å®‰é™çš„åœ°æ–¹" />
        <button id="sendBtn">å‘é€</button>
      </div>
      <div class="meta" id="meta"></div>
    </div>

    <nav>
      <button class="tab active" id="tabChat">AIèŠå¤©</button>
      <button class="tab" id="tabProfile">ç”¨æˆ·èµ„æ–™</button>
    </nav>
  </div>

  <script>
    const chatList = document.getElementById('chatList');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const meta = document.getElementById('meta');

    const viewChat = document.getElementById('view-chat');
    const viewProfile = document.getElementById('view-profile');
    const tabChat = document.getElementById('tabChat');
    const tabProfile = document.getElementById('tabProfile');

    const sidText = document.getElementById('sidText');
    const profileCards = document.getElementById('profileCards');
    const summaryText = document.getElementById('summaryText');
    const profileSummary = document.getElementById('profileSummary');
    const btnRefreshProfile = document.getElementById('btnRefreshProfile');
    const btnReset = document.getElementById('btnReset');
    const btnClearProfile = document.getElementById('btnClearProfile');
    const profileHint = document.getElementById('profileHint');

    function uuid() {
      return 'xxxxxxxyxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function getSessionId() {
      let sid = localStorage.getItem('intelligo_session_id');
      if (!sid) {
        sid = uuid();
        localStorage.setItem('intelligo_session_id', sid);
      }
      return sid;
    }

    const mainEl = document.querySelector('main');

    function isNearBottom(el, gap = 60) {
      return el.scrollHeight - el.scrollTop - el.clientHeight < gap;
    }

    function scrollMainToBottom() {
      requestAnimationFrame(() => {
        mainEl.scrollTop = mainEl.scrollHeight;
      });
    }

    function appendMsg(role, text) {
      const stick = isNearBottom(mainEl);
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
      div.textContent = text;
      chatList.appendChild(div);
      if (stick) scrollMainToBottom();
    }

    function pickNRandom(arr, n) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, Math.min(n, copy.length));
    }

    // ç”»åƒä¸ºç©ºæ—¶ï¼šæ—…è¡Œ/å‡ºè¡Œ/ç©¿è¡£ å„éšæœº 1 æ¡
    function fallbackExamples() {
      const travel = [
        'å‘¨æœ«æƒ³å»æ­å·ç©ä¸¤å¤©ï¼Œå–œæ¬¢å®‰é™çš„åœ°æ–¹',
        'æˆ‘æƒ³å»ä¸Šæµ·ç©ä¸¤å¤©ï¼Œå–œæ¬¢çƒ­é—¹ä¸€ç‚¹çš„åœ°æ–¹',
        'å¸¦çˆ¶æ¯å»è¥¿å®‰ä¸¤å¤©ï¼ŒèŠ‚å¥æ…¢ä¸€ç‚¹'
      ];
      const commute = [
        'ä»ä¸Šæµ·åˆ°è‹å·å½“å¤©å¾€è¿”æ€ä¹ˆå®‰æ’æœ€çœå¿ƒï¼Ÿ',
        'æˆ‘æ™šä¸Š10ç‚¹åˆ°å¹¿å·ç™½äº‘æœºåœºï¼Œæ€ä¹ˆå»å¸‚åŒºæ›´æ–¹ä¾¿ï¼Ÿ',
        'æˆ‘ä½åœ¨å—äº¬æ–°è¡—å£ï¼Œæ€ä¹ˆååœ°é“å»ä¸­å±±é™µï¼Ÿ'
      ];
      const clothing = [
        'æ˜å¤©åŒ—äº¬ç©¿ä»€ä¹ˆåˆé€‚ï¼Ÿ',
        'ä¸‹é›¨é™æ¸©äº†ï¼Œå¸®æˆ‘ç»™ä¸€å¥—é€šå‹¤ç©¿æ­å»ºè®®',
        'å»æµ·è¾¹ä¸¤å¤©éœ€è¦å¸¦å“ªäº›è¡£æœï¼Ÿ'
      ];
      return [
        pickNRandom(travel, 1)[0],
        pickNRandom(commute, 1)[0],
        pickNRandom(clothing, 1)[0],
      ];
    }

    function appendSuggestions(questions, titleText = 'ğŸ’¡ è¯•è¯•è¿™äº›é—®æ³•ï¼ˆç‚¹å‡»ç›´æ¥å‘é€ï¼‰ï¼š') {
      const stick = isNearBottom(mainEl);

      const box = document.createElement('div');
      box.className = 'suggestions';

      const title = document.createElement('div');
      title.className = 'suggestions-title';
      title.textContent = titleText;

      const list = document.createElement('div');
      list.className = 'suggestion-list';

      questions.forEach(q => {
        const btn = document.createElement('button');
        btn.className = 'suggestion-btn';
        btn.type = 'button';
        btn.textContent = 'â€¢ ' + q;
        btn.addEventListener('click', () => {
          sendText(q);
        });
        list.appendChild(btn);
      });

      box.appendChild(title);
      box.appendChild(list);
      chatList.appendChild(box);

      if (stick) scrollMainToBottom();
    }

    // æ–°å¢ï¼šåŸºäºç”»åƒè¯·æ±‚åç«¯ AI ç”Ÿæˆç¤ºä¾‹ï¼›å¤±è´¥åˆ™å›é€€æœ¬åœ°é¢˜åº“
    async function loadSuggestions() {
      const sid = getSessionId();

      // 1) ä¼˜å…ˆè¯·æ±‚åç«¯ï¼š/api/suggestions?session_id=...
      try {
        const res = await fetch('/api/suggestions?session_id=' + encodeURIComponent(sid));
        if (res.ok) {
          const data = await res.json();
          if (data && Array.isArray(data.questions) && data.questions.length > 0) {
            const qs = data.questions.slice(0, 3);
            const title = data.title || 'ğŸ’¡ ä¸ºä½ ç”Ÿæˆçš„ 3 ä¸ªé—®é¢˜ï¼ˆç‚¹å‡»å‘é€ï¼‰ï¼š';
            appendSuggestions(qs, title);
            return;
          }
        }
      } catch (_) {
        // ignoreï¼Œèµ° fallback
      }

      // 2) å›é€€ï¼šå¦‚æœä½ æš‚æ—¶è¿˜æ²¡åšåç«¯æ¥å£ï¼Œå°±ç”¨â€œæ—…è¡Œ/å‡ºè¡Œ/ç©¿è¡£â€éšæœºç¤ºä¾‹
      appendSuggestions(fallbackExamples(), 'ğŸ’¡ è¯•è¯•è¿™äº›é—®æ³•ï¼ˆç‚¹å‡»ç›´æ¥å‘é€ï¼‰ï¼š');
    }

    async function sendText(message) {
      const msg = (message ?? input.value).trim();
      if (!msg) return;

      const sid = getSessionId();
      appendMsg('user', msg);
      scrollMainToBottom();
      input.value = '';
      sendBtn.disabled = true;
      meta.textContent = 'æ€è€ƒä¸­...';

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sid, message: msg })
        });
        if (!res.ok) {
          const err = await res.text();
          throw new Error(err);
        }
        const data = await res.json();
        appendMsg('ai', data.reply);
        meta.textContent = `intent=${data.intent_type || '-'} node=${data.current_node || '-'}`;
      } catch (e) {
        appendMsg('ai', 'è¯·æ±‚å¤±è´¥ï¼š' + (e?.message || e));
        meta.textContent = 'å‡ºé”™äº†';
      } finally {
        sendBtn.disabled = false;
      }
    }

    async function refreshProfile() {
      const sid = getSessionId();
      sidText.textContent = sid;
      profileHint.textContent = 'åŠ è½½ä¸­...';
      try {
        const res = await fetch('/api/profile?session_id=' + encodeURIComponent(sid));
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        renderFormattedProfile(data.formatted || {});
        profileHint.textContent = 'å·²æ›´æ–°';
      } catch (e) {
        profileHint.textContent = 'åŠ è½½å¤±è´¥ï¼š' + (e?.message || e);
      }
    }

    function renderFormattedProfile(formatted) {
      const { summary, cards } = formatted;

      if (summary) {
        summaryText.textContent = summary;
        profileSummary.style.display = 'block';
      } else {
        summaryText.textContent = 'æš‚æ— åå¥½è®°å½•';
        profileSummary.style.display = 'block';
      }

      profileCards.innerHTML = '';

      if (!cards || cards.length === 0) {
        profileCards.innerHTML = '<div class="profile-empty">è¿˜æ²¡æœ‰è®°å½•ä½ çš„åå¥½ï¼ŒèŠèŠå¤©å°±ä¼šè‡ªåŠ¨å­¦ä¹ ~</div>';
        return;
      }

      cards.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = 'profile-card';

        const headerEl = document.createElement('div');
        headerEl.className = 'profile-card-header';
        headerEl.innerHTML = `<span class="profile-card-icon">${card.icon}</span><span>${card.title}</span>`;
        cardEl.appendChild(headerEl);

        const itemsEl = document.createElement('div');
        itemsEl.className = 'profile-card-items';

        card.items.forEach((item) => {
          const itemWrapper = document.createElement('div');

          const itemEl = document.createElement('div');
          itemEl.className = 'profile-item';

          const textEl = document.createElement('span');
          textEl.className = 'profile-item-text';
          textEl.textContent = item.text;

          const sourceBtn = document.createElement('span');
          sourceBtn.className = 'profile-item-source';
          sourceBtn.textContent = 'æ¥æº';
          sourceBtn.onclick = () => {
            const detail = itemWrapper.querySelector('.source-detail');
            detail.classList.toggle('show');
          };

          itemEl.appendChild(textEl);
          itemEl.appendChild(sourceBtn);
          itemWrapper.appendChild(itemEl);

          const sourceDetail = document.createElement('div');
          sourceDetail.className = 'source-detail';
          if (item.source) {
            sourceDetail.innerHTML = `
              <div><b>åŸå§‹è®°å½•ï¼š</b>${item.source.original || '-'}</div>
              <div><b>ç±»åˆ«ï¼š</b>${item.source.category || '-'}</div>
              <div><b>æ—¶é—´ï¼š</b>${item.source.timestamp ? item.source.timestamp.split('T')[0] : '-'}</div>
              <div><b>æ¥æºï¼š</b>${item.source.source_type || '-'}</div>
            `;
          }
          itemWrapper.appendChild(sourceDetail);
          itemsEl.appendChild(itemWrapper);
        });

        cardEl.appendChild(itemsEl);
        profileCards.appendChild(cardEl);
      });
    }

    async function clearProfile() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç”¨æˆ·ç”»åƒå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

      profileHint.textContent = 'æ¸…ç©ºä¸­...';
      try {
        const res = await fetch('/api/clear_profile', { method: 'POST' });
        if (!res.ok) throw new Error(await res.text());

        summaryText.textContent = 'æš‚æ— åå¥½è®°å½•';
        profileCards.innerHTML = '<div class="profile-empty">è¿˜æ²¡æœ‰è®°å½•ä½ çš„åå¥½ï¼ŒèŠèŠå¤©å°±ä¼šè‡ªåŠ¨å­¦ä¹ ~</div>';
        profileHint.textContent = 'ç”¨æˆ·ç”»åƒå·²æ¸…ç©º';
      } catch (e) {
        profileHint.textContent = 'æ¸…ç©ºå¤±è´¥ï¼š' + (e?.message || e);
      }
    }

    async function resetSession() {
      const sid = getSessionId();
      profileHint.textContent = 'é‡ç½®ä¸­...';
      try {
        const res = await fetch('/api/reset?session_id=' + encodeURIComponent(sid), { method: 'POST' });
        if (!res.ok) throw new Error(await res.text());

        localStorage.removeItem('intelligo_session_id');
        const newSid = getSessionId();
        sidText.textContent = newSid;
        profileHint.textContent = 'å·²é‡ç½®ï¼ˆæ–°ä¼šè¯ï¼‰';
        chatList.innerHTML = '';
      } catch (e) {
        profileHint.textContent = 'é‡ç½®å¤±è´¥ï¼š' + (e?.message || e);
      }
    }

    tabChat.addEventListener('click', () => {
      tabChat.classList.add('active');
      tabProfile.classList.remove('active');
      viewChat.classList.remove('hidden');
      viewProfile.classList.add('hidden');
      document.getElementById('composer').classList.remove('hidden');
    });

    tabProfile.addEventListener('click', async () => {
      tabProfile.classList.add('active');
      tabChat.classList.remove('active');
      viewProfile.classList.remove('hidden');
      viewChat.classList.add('hidden');
      document.getElementById('composer').classList.add('hidden');
      await refreshProfile();
    });

    sendBtn.addEventListener('click', () => sendText());
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendText();
    });
    btnRefreshProfile.addEventListener('click', refreshProfile);
    btnReset.addEventListener('click', resetSession);
    btnClearProfile.addEventListener('click', clearProfile);

    (function init() {
      const sid = getSessionId();
      sidText.textContent = sid;

      appendMsg('ai', 'ä»Šå¤©æƒ³å»å“ªï¼ŸğŸ˜„');
      loadSuggestions(); // å…³é”®ï¼šå¯åŠ¨æ—¶åŠ è½½ã€ŒAI/å›é€€ã€ç¤ºä¾‹
    })();
  </script>
</body>
</html>